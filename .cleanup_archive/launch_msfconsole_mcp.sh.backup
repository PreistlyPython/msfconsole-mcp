#!/bin/bash

# Launch script for MSFconsole MCP
# This script starts the MSFconsole MCP with proper environment settings

set -e

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
cd "$SCRIPT_DIR"

# Enable detailed logging
exec > >(tee -a "logs/msfconsole_mcp_launcher_$(date +%Y%m%d_%H%M%S).log")
exec 2>&1

echo "========================================="
echo "Starting MSFconsole MCP Launch: $(date)"
echo "========================================="
echo "Working directory: $(pwd)"

# Create logs directory if it doesn't exist
mkdir -p logs

# Check for Python virtual environment
if [ ! -d "venv" ]; then
    echo "ERROR: Virtual environment not found."
    echo "Please run ./fix_python_version.sh first to set up the environment."
    exit 1
fi

# Activate the virtual environment
source venv/bin/activate
echo "Using Python: $(which python) ($(python --version))"

# Add venv path to PYTHONPATH to ensure modules are found
VENV_SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
export PYTHONPATH="$VENV_SITE_PACKAGES:$PYTHONPATH"
echo "PYTHONPATH set to: $PYTHONPATH"

# Check Python version and packages
echo "Installed packages:"
pip list | grep -E "mcp|typing-extensions|asyncio"

# Check if MCP can be imported
if ! python -c "import mcp.server.fastmcp" &>/dev/null; then
    echo "ERROR: Cannot import MCP. Please run ./fix_python_version.sh again."
    exit 1
fi

# Check if safe_context.py exists
if [ ! -f "safe_context.py" ]; then
    echo "ERROR: safe_context.py not found. Please make sure it exists in the current directory."
    exit 1
fi

# Check if Metasploit Framework is installed
if ! command -v msfconsole &> /dev/null; then
    echo "WARNING: msfconsole not found in PATH. Some functionality may be limited."
else
    echo "Found msfconsole: $(which msfconsole)"
    msfconsole -v | head -n 1
fi

# Run the MCP server with proper error handling
echo "========================================="
echo "Starting MSFconsole MCP server..."
echo "========================================="
LOG_FILE="logs/msfconsole_mcp_$(date +%Y%m%d_%H%M%S).log"
python -u msfconsole_mcp.py 2>&1 | tee "$LOG_FILE"
